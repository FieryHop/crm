# Lead Distribution CRM

Мини-CRM система для автоматического распределения лидов между операторами с учетом загрузки и весов распределения по источникам.

## Оглавление

- [Технологии](#технологии)
- [Быстрый старт](#быстрый-старт)
- [API Эндпоинты](#api-эндпоинты)
- [Модель данных](#модель-данных)
- [Алгоритм распределения](#алгоритм-распределения)


## Технологии

- **Python** 3.8+
- **FastAPI** - современный веб-фреймворк
- **SQLAlchemy** - ORM для работы с базой данных
- **SQLite** - база данных
- **Pydantic** - валидация данных

## Быстрый старт

### Установка зависимостей

```bash
pip install fastapi==0.104.1 pydantic==1.10.17 sqlalchemy==1.4.51 uvicorn==0.24.0
```

### Запуск приложения
```bash
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```
Приложение будет доступно по адресу: http://localhost:8000

### Документация API
После запуска доступна автоматическая документация:

- Swagger UI: http://localhost:8000/docs

- ReDoc: http://localhost:8000/redoc

## API Эндпоинты
### Управление операторами
Создание оператора
```bash
curl -X POST "http://localhost:8000/operators/" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Оператор Иван",
    "is_active": true,
    "max_load": 5
  }'
```
Получение списка операторов
```bash
curl -X GET "http://localhost:8000/operators/"
```
Обновление оператора

```bash
curl -X PUT "http://localhost:8000/operators/1" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Иван Обновленный",
    "is_active": true,
    "max_load": 7
  }'
```
### Управление источниками
Создание источника
```bash
curl -X POST "http://localhost:8000/sources/" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Telegram Bot"
  }'
```
Получение списка источников
```bash
curl -X GET "http://localhost:8000/sources/"
```
### Настройка распределения
Назначение оператора на источник
```bash
curl -X POST "http://localhost:8000/assignments/" \
  -H "Content-Type: application/json" \
  -d '{
    "operator_id": 1,
    "source_id": 1,
    "weight": 10
  }'
```
Просмотр назначений
```bash
curl -X GET "http://localhost:8000/assignments/"
```
### Работа с лидами и обращениями
Регистрация нового обращения
```bash
curl -X POST "http://localhost:8000/contacts/" \
  -H "Content-Type: application/json" \
  -d '{
    "lead_external_id": "+79161234567",
    "source_id": 1
  }'
```
Просмотр списка лидов
```bash
curl -X GET "http://localhost:8000/leads/"
```
Просмотр списка обращений
```bash
curl -X GET "http://localhost:8000/contacts/"
```
### Модель данных
Структура базы данных \
text \
```
Operator (Оператор) 
├── id (ID) 
├── name (Имя) 
├── is_active (Активен) 
├── max_load (Макс. нагрузка) 
├── current_load (Текущая нагрузка) 
├── assignments (Назначения на источники) 
└── contacts (Обращения) 

Lead (Лид) 
├── id (ID) 
├── external_id (Внешний ID: телефон/email) 
├── created_at (Дата создания) 
└── contacts (Обращения лида) 

Source (Источник/Бот) 
├── id (ID) 
├── name (Название) 
├── assignments (Назначения операторов) 
└── contacts (Обращения из источника)

OperatorAssignment (Назначение) 
├── id (ID) 
├── operator_id (ID оператора) 
├── source_id (ID источника) 
└── weight (Вес распределения) 

Contact (Обращение) 
├── id (ID) 
├── lead_id (ID лида) 
├── source_id (ID источника) 
├── operator_id (ID оператора) 
├── created_at (Дата создания) 
├── lead (Лид) 
├── source (Источник) 
└── operator (Оператор) 
```
### Алгоритм распределения
#### 1. Идентификация лида
- Лиды идентифицируются по полю external_id (телефон, email или другой уникальный идентификатор)

- При создании обращения система ищет существующего лида по external_id

- Если лид не найден - создается новый

#### 2. Определение доступных операторов
Для каждого источника система находит:

- Активных операторов (is_active = true)

- Операторов, не превысивших лимит нагрузки (current_load < max_load)

- Операторов, назначенных на данный источник с указанными весами

#### 3. Распределение по весам
- Используется вероятностный алгоритм на основе весов

- Вероятность выбора оператора = вес_оператора / сумма_весов

- Пример: оператор с весом 20 имеет в 2 раза больше шансов получить обращение, чем оператор с весом 10

#### 4. Учет нагрузки
- При назначении обращения нагрузка оператора увеличивается (current_load += 1)

- Операторы с нагрузкой выше лимита исключаются из распределения

#### 5. Обработка отсутствия операторов
- Если нет подходящих операторов, обращение создается без назначения

- Оператор остается null в таком случае
